<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Problem Table</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .table tbody tr {
            height: 100px; /* Adjust the height as needed */
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h2>Problem Table</h2>
    <textarea id="sortingTextArea" class="form-control mb-2" rows="3" placeholder="Enter text for character count..."></textarea>
    <button id="countCharactersButton" class="btn btn-primary mb-2">Count Characters</button>
    <textarea id="outputWindow" class="form-control mb-2" rows="5" readonly></textarea>
    <button id="sortTableButton" class="btn btn-secondary mb-2">Sort Table</button>
    <button id="updateSelectedButton" style="width: 100%; background-color: blue; color: white; margin-bottom: 10px;">Update Selected</button>
    
    <!-- Dropdowns for subject and category -->
    <div class="mb-2">
        <select id="subjectDropdown" class="form-control mb-2">
            <option value="chinese">Chinese</option>
            <option value="tmp">Temporary</option>
        </select>
        <select id="categoryDropdown" class="form-control mb-2">
            <option value="练习">练习</option>
            <option value="备选练习1">备选练习</option>
        </select>
    </div>
    
    <button id="fetchProblemDataButton" class="btn btn-success mb-2">Fetch Problem Data</button>
    
    <!-- Problem table will be added dynamically here -->
    <div id="problemTableContainer"></div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function(){
    var problemData = []; // Store problem data globally

    // Function to fetch problem data from service endpoint
    function fetchProblemData(table, subject, category) {
        $.ajax({
            url: '/math/general/data?table=' + table + '&subject=' + subject + '&category=' + category,
            type: 'GET',
            success: function(response) {
                problemData = response;
                populateProblemTable(problemData);
            },
            error: function(error) {
                console.error('Error fetching problem data:', error);
            }
        });
    }

    // Function to populate the problem table with data
    function populateProblemTable(data) {
        // Clear existing problem table
        $('#problemTableContainer').empty();

        // Create problem table
        var problemTable = $('<div class="table-responsive"><table class="table table-bordered"><thead><tr><th></th><th>Index</th><th>ID</th><th>Subject</th><th>Description</th><th>Solution</th><th>Category</th><th>Subcategory</th><th>Subcategory ID</th><th>Importance</th></tr></thead><tbody></tbody></table></div>');
        var problemTableBody = problemTable.find('tbody');

        // Populate problem table rows
        data.forEach(function(problem, index) {
            var row = $('<tr><td><input type="checkbox" class="problem-checkbox" value="' + problem.id + '"></td><td>' + (index + 1) + '</td><td class="problem-id">' + problem.id + '</td><td class="problem-subject" contenteditable="true">' + problem.subject + '</td><td class="problem-description" contenteditable="true">' + problem.description + '</td><td class="problem-solution" contenteditable="true">' + problem.solution + '</td><td class="problem-category" contenteditable="true">' + problem.category + '</td><td class="problem-subcategory" contenteditable="true">' + problem.mathSubCategory.name + '</td><td class="problem-subcategory-id" contenteditable="true">' + problem.mathSubCategory.id + '</td><td class="problem-importance" contenteditable="true">' + problem.importance + '</td></tr>');
            problemTableBody.append(row);
        });

        // Append problem table to container
        $('#problemTableContainer').append(problemTable);
    }

    // Function to count character appearances in all descriptions
    function countCharAppearances(data, text) {
        var charCounts = {};
        text.split('').forEach(function(char) {
            charCounts[char] = 0;
        });

        data.forEach(function(problem) {
            var description = problem.description;
            for (var i = 0; i < text.length; i++) {
                var char = text[i];
                if (description.includes(char)) {
                    charCounts[char]++;
                }
            }
        });
        return charCounts;
    }

    // Function to display character counts in ascending order
    function displayCharCounts(charCounts) {
        var sortedCounts = {};
        Object.keys(charCounts).sort((a, b) => charCounts[a] - charCounts[b]).forEach(function(key) {
            if (!sortedCounts[charCounts[key]]) {
                sortedCounts[charCounts[key]] = [];
            }
            sortedCounts[charCounts[key]].push(key);
        });

        var output = '';
        Object.keys(sortedCounts).forEach(function(count) {
            output += count + ': ' + sortedCounts[count].join(', ') + '\n';
        });

        $('#outputWindow').val(output);
    }

    // Function to sort table based on output window
    function sortTableBasedOnOutput() {
        var output = $('#outputWindow').val();
        var charGroups = {};
        var problemRows = [];

        // Parse output window
        output.split('\n').forEach(function(line) {
            if (line.trim().length > 0) {
                var parts = line.split(':');
                var count = parseInt(parts[0].trim());
                var chars = parts[1].trim().split(',').map(function(c) { return c.trim(); });
                charGroups[count] = chars;
            }
        });

        // Sort problemData based on character groups
        problemData.sort(function(a, b) {
            var aGroup = findCharGroup(a.description, charGroups);
            var bGroup = findCharGroup(b.description, charGroups);
            return aGroup - bGroup;
        });

        // Repopulate problem table with sorted data
        populateProblemTable(problemData);
    }

    // Function to find the group of the first matching character in the description
    function findCharGroup(description, charGroups) {
        for (var group in charGroups) {
            for (var i = 0; i < charGroups[group].length; i++) {
                if (description.includes(charGroups[group][i])) {
                    return parseInt(group);
                }
            }
        }
        return Number.MAX_SAFE_INTEGER; // If no character is found, place at the end
    }

    // Event handler for count characters button
    $('#countCharactersButton').click(function() {
        var text = $('#sortingTextArea').val();
        var charCounts = countCharAppearances(problemData, text);
        displayCharCounts(charCounts);
    });

    // Event handler for sort table button
    $('#sortTableButton').click(function() {
        sortTableBasedOnOutput();
    });

    // Event handler for fetch problem data button
    $('#fetchProblemDataButton').click(function() {
        var selectedSubject = $('#subjectDropdown').val();
        var selectedCategory = $('#categoryDropdown').val();
        fetchProblemData('math_problem', selectedSubject, selectedCategory);
    });

    // Register click function for "Update Selected" button
    $('#updateSelectedButton').click(function() {
        var selectedProblems = [];
        $('#problemTableContainer').find('.problem-checkbox:checked').each(function() {
            var problemRow = $(this).closest('tr');
            var problem = {
                id: problemRow.find('.problem-id').text(),
                subject: problemRow.find('.problem-subject').text(),
                description: problemRow.find('.problem-description').text(),
                solution: problemRow.find('.problem-solution').text(),
                category: problemRow.find('.problem-category').text(),
                mathSubCategory: {
                    id: problemRow.find('.problem-subcategory-id').text(),
                    name: problemRow.find('.problem-subcategory').text()
                },
                importance: problemRow.find('.problem-importance').text()
            };
            selectedProblems.push(problem);
        });

        // Send selected problems to server for update
        $.ajax({
            url: '/math/update-all',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(selectedProblems),
            success: function(response) {
                console.log('Successfully updated problems:', response);
                window.alert("update success");
                // Uncheck checkboxes of updated rows
                $('#problemTableContainer').find('.problem-checkbox:checked').prop('checked', false);
            },
            error: function(error) {
                console.error('Error updating problems:', error);
                window.alert("update error");
                // Optionally, you can display an error message here
            }
        });
    });

});
</script>

</body>
</html>
