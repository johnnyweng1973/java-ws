<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
<head>
    <title>Manage MathProblems</title>
    <style>
        /* Style the text area to set width and height */
        #textArea {
            width: 800px; /* Set the width of the text area */
            height: 200px; /* Set the height of the text area */
            overflow-y: auto; /* Add a vertical scroll bar */
            overflow-x:auto;
            resize: none; /* Disable resizing of the text area */
        }
        .framed-cell {
            border: 1px solid black; /* Add frame */
            width: 50%; /* Set width to 50% */
        }
        .input-match-height {
            width: 100%;
            height: 100%;
            border: none;
            padding: 0;
            margin: 0;
            resize: none; /* Prevent resizing of textarea */
            outline: none; /* Remove the outline when focused */
        }
        .audio-answer {
            display: flex;
            align-items: center;
        }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
</head>
<body>
  <div class="container my-5">
    <form id="myForm">
    <h2 th:text="${sub} + ' Test'"></h2>
   
        <table>
          <thead>
                <tr>
                    <th>Index</th> <!-- Added Index column -->
                    <th>Problem Description</th>
                    <th>Solution</th>
                    <th>Answer</th>
                    <th>Audio Answer</th>
                </tr>
            </thead>
            <tbody>
                 <tr th:each="problem, index : ${problems}">
                    <td class="framed-cell" style="width: 5%;font-family: 楷体, KaiTi, serif;font-size: 24px;" th:text="${index.index + 1}"></td> <!-- Displaying Index here -->
                   <td class="framed-cell problem-description" style="width: 40%;font-family: 楷体, KaiTi, serif;font-size: 48px;" th:text="${problem.problemDescription}"></td>
                   <td class="framed-cell" style="width: 35%;font-size: 36px;">
                        <textarea th:text="${problem.solution}" name="solution" class="input-match-height" id="'solutionField-' + ${index.index}"></textarea>
                        <!-- Hidden fields for other properties -->
                         <input type="hidden" th:value="${problem.id}" name="id"/>
                        <input type="hidden" th:value="${problem.problemId}" name="problemId"/>
                        <input type="hidden" th:value="${problem.category}" name="category"/>
                        <input type="hidden" th:value="${problem.subcategory}" name="subcategory"/>
                        <input type="hidden" th:value="${problem.subcategoryId}" name="subcategoryId"/>
                        </td>
            
                    <td class="framed-cell" style="width: 20%;">
                        <textarea th:text="${problem.answer}" name="answer" onpaste="return false;" class="input-match-height"></textarea>
                    </td>
                    <td class="framed-cell audio-answer" style="width: 20%;">
                        <button type="button" onclick="startRecording(this)">Start</button>
                        <button type="button" onclick="stopRecording(this)" disabled>Stop</button>
                        <button type="button" onclick="playRecording(this)" disabled>Play</button>
                        <audio controls hidden></audio>
                        <input type="hidden" name="audioAnswer" />
                    </td>
                </tr>
            </tbody>
        </table>
        <button id="submitButton" type="button" onclick="submitForm()">Submit</button>
    </form>
  </div>
  
<!-- jQuery library -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap Bundle with Popper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <script>
    function submitForm() {
        var formData = []; 
        document.querySelectorAll('tr').forEach(function(row, index) {
            
            if (index >= 1){
            	var problem = {};
            	problem['subject']="chinese";
            	 // Retrieve problemDescription from the row using the new class name
                var problemDescription = row.querySelector('.problem-description').textContent;
                problem['problemDescription'] = problemDescription.trim();
             // Retrieve solution from the textarea
                var solutionTextarea = row.querySelector('textarea[name="solution"]');
                problem['solution'] = solutionTextarea ? solutionTextarea.value : null;
                
                // Retrieve answer from the textarea
                var answerTextarea = row.querySelector('textarea[name="answer"]');
                problem['answer'] = answerTextarea ? answerTextarea.value : null;
                
                // Retrieve other properties from the hidden input fields
                problem['id'] = getValueFromInput(row.querySelector('input[name="id"]'));
                problem['problemId'] = getValueFromInput(row.querySelector('input[name="problemId"]'));
                problem['category'] = getValueFromInput(row.querySelector('input[name="category"]'));
                problem['subcategory'] = getValueFromInput(row.querySelector('input[name="subcategory"]'));
                problem['subcategoryId'] = getValueFromInput(row.querySelector('input[name="subcategoryId"]'));
                
                // Retrieve the recorded audio
                var audioBlob = row.querySelector('input[name="audioAnswer"]').value;
                problem['audioAnswer'] = audioBlob ? audioBlob : null;
                
                formData.push(problem);
            }
        });

        function getValueFromInput(inputElement) {
            return inputElement ? inputElement.value : null;
        }
        
        fetch('/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        }).then(response => {
        		  window.location.href = '/test-success';
        }).catch(error => {
            // Handle error
            console.error('Error:', error);
        });
    }
    
    // Audio recording
    let recordRTC;

    function startRecording(button) {
        const row = button.closest('tr');
        button.nextElementSibling.disabled = false;
        button.disabled = true;

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                recordRTC = RecordRTC(stream, {
                    type: 'audio',
                    mimeType: 'audio/webm',
                    desiredSampRate: 8000, // Lower bitrate
                    recorderType: StereoAudioRecorder,
                    numberOfAudioChannels: 1
                });

                recordRTC.startRecording();
            })
            .catch(error => {
                console.error('Error accessing media devices.', error);
            });
    }

    function stopRecording(button) {
        const row = button.closest('tr');
        button.previousElementSibling.disabled = false;
        button.disabled = true;

        if (recordRTC) {
            recordRTC.stopRecording(() => {
                let audioBlob = recordRTC.getBlob();
                alert('Audio data size: ' + audioBlob.size + ' bytes'); // Alert the size of the audio data
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    const base64String = reader.result.split(',')[1];
                    row.querySelector('input[name="audioAnswer"]').value = base64String;
                    row.querySelector('audio').src = reader.result;
                    row.querySelector('audio').hidden = false;
                    row.querySelector('button[onclick="playRecording(this)"]').disabled = false;
                };
            });
        } else {
            alert('RecordRTC not initialized.');
        }
    }

    function playRecording(button) {
        const row = button.closest('tr');
        const audio = row.querySelector('audio');
        if (audio) {
            audio.play();
        }
    }
    
</script>
</body>
</html>
